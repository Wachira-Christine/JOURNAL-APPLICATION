<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My Calendar</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: "Merriweather";
            margin:0;
            padding:0;
            background:#f9f9f9;
            background-image: url('{{ url_for("static", filename="images/calendar.jpeg") }}');
            background-size: cover;
        }
        header {
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:10px;
            background:#A0522D;
            color:white;
        }
        header button {
            padding:8px 15px;
            border:none;
            border-radius:5px;
            cursor:pointer;
            color:white;
            background:#3E1F1F;
            font-weight: 600;
        }
        header button:hover {
            background:#2a1414;
        }
        .month-nav {
            display:flex;
            justify-content:center;
            gap:10px;
            margin:10px 0;
        }
        .month-nav button {
            padding:8px 15px;
            border:none;
            border-radius:5px;
            background:#3E1F1F;
            color:white;
            cursor:pointer;
            font-weight: 600;
        }
        .month-nav button:hover {
            background:#2a1414;
        }
        #calendar {
            display:grid;
            grid-template-columns: repeat(7, 1fr);
            gap:5px;
            padding:10px;
            max-width: 1200px;
            margin: 0 auto;
        }
        .day {
            padding:15px;
            background:#fff;
            border-radius:8px;
            cursor:pointer;
            text-align:center;
            min-height:80px;
            position:relative;
            box-shadow:0 2px 6px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .day:hover {
            background:#e0e0ff;
            transform: translateY(-2px);
            box-shadow:0 4px 12px rgba(0,0,0,0.15);
        }
        .day-header {
            font-weight: bold;
            background: #A0522D;
            color: white;
            padding: 10px;
            border-radius: 8px;
        }
        .event {
            font-size:0.75em;
            margin-top:5px;
            border-radius:3px;
            padding:3px 5px;
            color:white;
            display:block;
            overflow:hidden;
            text-overflow:ellipsis;
            white-space:nowrap;
            cursor: pointer;
        }

        /* Modal styles */
        .modal {
            display:none;
            position:fixed;
            z-index:1000;
            left:0;
            top:0;
            width:100%;
            height:100%;
            overflow:auto;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }
        .modal-content {
            background-color:#fefefe;
            margin:5% auto;
            padding:30px;
            border-radius:15px;
            width:90%;
            max-width:500px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .close-btn {
            color:#aaa;
            float:right;
            font-size:28px;
            cursor:pointer;
            font-weight: bold;
        }
        .close-btn:hover {
            color:black;
        }
        #eventList {
            margin: 20px 0;
            max-height: 300px;
            overflow-y: auto;
        }
        .event-item {
            display:flex;
            justify-content:space-between;
            align-items:center;
            margin:8px 0;
            padding:10px;
            border-radius:8px;
            color:white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .event-item-buttons {
            display: flex;
            gap: 5px;
        }
        .event-item button {
            background:#fff;
            color:#3E1F1F;
            border:none;
            padding:5px 10px;
            border-radius:5px;
            cursor:pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        .event-item button:hover {
            background:#eee;
            transform: scale(1.05);
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #newEventInput {
            flex: 1;
            padding:10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        #newEventInput:focus {
            outline: none;
            border-color: #A0522D;
        }
        #addEventBtn {
            padding:10px 20px;
            border:none;
            border-radius:8px;
            background:#A0522D;
            color:white;
            cursor:pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        #addEventBtn:hover {
            background:#8B4513;
            transform: scale(1.05);
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
    </style>
</head>

<body>

<header>
    <h1 id="monthYear"></h1>
    <button onclick="window.location.href='/journal'"><i class="fas fa-arrow-left"></i> Back to Journal</button>
</header>

<div class="month-nav">
    <button id="prevMonth"><i class="fas fa-chevron-left"></i> Previous</button>
    <button id="nextMonth">Next <i class="fas fa-chevron-right"></i></button>
</div>

<div id="calendar"></div>

<!-- Day Modal -->
<div id="dayModal" class="modal">
    <div class="modal-content">
        <span class="close-btn">&times;</span>
        <h2 id="modalDate"></h2>
        <div id="eventList"></div>
        <div class="input-group">
            <input type="text" id="newEventInput" placeholder="Add new event..." />
            <button id="addEventBtn"><i class="fas fa-plus"></i> Add</button>
        </div>
    </div>
</div>

<script>
    const API_BASE = 'http://127.0.0.1:5000';
    const calendarDiv = document.getElementById('calendar');
    const monthYearHeader = document.getElementById('monthYear');
    let currentDate = new Date();

    // Modal elements
    const dayModal = document.getElementById('dayModal');
    const modalDate = document.getElementById('modalDate');
    const eventList = document.getElementById('eventList');
    const newEventInput = document.getElementById('newEventInput');
    const addEventBtn = document.getElementById('addEventBtn');
    const closeBtn = document.querySelector('.close-btn');

    let selectedDate = "";
    let allEvents = [];

    const weekDays = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
    const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];

    // Load events from database
    async function loadEvents() {
        try {
            const month = currentDate.getMonth() + 1;
            const year = currentDate.getFullYear();

            const response = await fetch(`${API_BASE}/api/calendar-events?month=${month}&year=${year}`, {
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                allEvents = result.events;
                renderCalendar(currentDate);
            }
        } catch (error) {
            console.error('Error loading events:', error);
        }
    }

    // Render calendar
    function renderCalendar(date){
        calendarDiv.innerHTML = "";
        monthYearHeader.textContent = `${monthNames[date.getMonth()]} ${date.getFullYear()}`;

        // Weekday headers
        weekDays.forEach(d=>{
            const div = document.createElement('div');
            div.className = 'day-header';
            div.textContent = d;
            calendarDiv.appendChild(div);
        });

        const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay();
        const daysInMonth = new Date(date.getFullYear(), date.getMonth()+1, 0).getDate();

        // Empty cells before first day
        for(let i=0; i<firstDay; i++){
            calendarDiv.appendChild(document.createElement('div'));
        }

        // Days of the month
        for(let day=1; day<=daysInMonth; day++){
            const dayDiv = document.createElement('div');
            dayDiv.classList.add('day');

            const dateStr = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            dayDiv.dataset.date = dateStr;

            const dayNumber = document.createElement('div');
            dayNumber.style.fontWeight = 'bold';
            dayNumber.style.marginBottom = '5px';
            dayNumber.textContent = day;
            dayDiv.appendChild(dayNumber);

            // Render existing events
            const dayEvents = allEvents.filter(e => e.date === dateStr);
            dayEvents.forEach(ev=>{
                const evDiv = document.createElement('div');
                evDiv.classList.add('event');
                evDiv.style.backgroundColor = getRandomColor();
                evDiv.textContent = ev.title;
                evDiv.title = ev.description || ev.title;
                dayDiv.appendChild(evDiv);
            });

            // Click to open day modal
            dayDiv.addEventListener('click', ()=>{
                selectedDate = dateStr;
                const dateObj = new Date(dateStr);
                modalDate.textContent = `${monthNames[dateObj.getMonth()]} ${dateObj.getDate()}, ${dateObj.getFullYear()}`;
                newEventInput.value = "";
                renderEventList();
                dayModal.style.display = "block";
            });

            calendarDiv.appendChild(dayDiv);
        }
    }

    // Render events inside modal
    function renderEventList() {
        eventList.innerHTML = "";
        const dayEvents = allEvents.filter(e => e.date === selectedDate);

        if(dayEvents.length === 0){
            eventList.innerHTML = '<p style="text-align:center; color:#666;">No events for this day</p>';
            return;
        }

        dayEvents.forEach((ev)=>{
            const div = document.createElement('div');
            div.classList.add('event-item');
            div.style.backgroundColor = getRandomColor();

            const textSpan = document.createElement('span');
            textSpan.textContent = ev.title;
            if(ev.description) {
                textSpan.title = ev.description;
            }
            div.appendChild(textSpan);

            const buttonsDiv = document.createElement('div');
            buttonsDiv.className = 'event-item-buttons';

            // Edit button
            const editBtn = document.createElement('button');
            editBtn.innerHTML = '<i class="fas fa-edit"></i>';
            editBtn.addEventListener('click', async ()=>{
                const newTitle = prompt("Edit event title:", ev.title);
                if(newTitle === null) return;

                const newDesc = prompt("Edit event description:", ev.description || '');
                if(newDesc === null) return;

                if(newTitle.trim() === ""){
                    await deleteEvent(ev.id);
                } else {
                    await updateEvent(ev.id, newTitle, newDesc);
                }
            });

            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
            deleteBtn.addEventListener('click', async ()=>{
                if(confirm('Delete this event?')) {
                    await deleteEvent(ev.id);
                }
            });

            buttonsDiv.appendChild(editBtn);
            buttonsDiv.appendChild(deleteBtn);
            div.appendChild(buttonsDiv);
            eventList.appendChild(div);
        });
    }

    // Add new event
    addEventBtn.addEventListener('click', async ()=>{
        const text = newEventInput.value.trim();
        if(text === "") return;

        try {
            const response = await fetch(`${API_BASE}/api/calendar-events`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    event_title: text,
                    event_description: '',
                    event_date: selectedDate,
                    event_time: null
                })
            });

            const result = await response.json();

            if (result.success) {
                newEventInput.value = "";
                await loadEvents();
                renderEventList();
            } else {
                alert('Failed to add event: ' + result.message);
            }
        } catch (error) {
            console.error('Error adding event:', error);
            alert('Failed to add event. Please try again.');
        }
    });

    // Update event
    async function updateEvent(eventId, title, description) {
        try {
            const response = await fetch(`${API_BASE}/api/calendar-events/${eventId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({
                    event_title: title,
                    event_description: description,
                    event_date: selectedDate,
                    event_time: null
                })
            });

            const result = await response.json();

            if (result.success) {
                await loadEvents();
                renderEventList();
            } else {
                alert('Failed to update event');
            }
        } catch (error) {
            console.error('Error updating event:', error);
            alert('Failed to update event. Please try again.');
        }
    }

    // Delete event
    async function deleteEvent(eventId) {
        try {
            const response = await fetch(`${API_BASE}/api/calendar-events/${eventId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            const result = await response.json();

            if (result.success) {
                await loadEvents();
                renderEventList();
            } else {
                alert('Failed to delete event');
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            alert('Failed to delete event. Please try again.');
        }
    }

    // Helper to get random color for events
    function getRandomColor() {
        const colors = ['#574fd6', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#30cfd0', '#a8edea'];
        return colors[Math.floor(Math.random() * colors.length)];
    }

    // Close modal
    closeBtn.addEventListener('click', ()=>{
        dayModal.style.display = "none";
    });

    // Close modal on outside click
    window.addEventListener('click', (e)=>{
        if(e.target == dayModal) dayModal.style.display = "none";
    });

    // Allow Enter key to add event
    newEventInput.addEventListener('keypress', (e)=>{
        if(e.key === 'Enter') addEventBtn.click();
    });

    // Month navigation
    document.getElementById('prevMonth').addEventListener('click', ()=>{
        currentDate.setMonth(currentDate.getMonth()-1);
        loadEvents();
    });

    document.getElementById('nextMonth').addEventListener('click', ()=>{
        currentDate.setMonth(currentDate.getMonth()+1);
        loadEvents();
    });

    // Initial load
    loadEvents();
</script>

</body>
</html>